<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CHARI Launch</title>
    <!-- Use CDN for launch to avoid build complexity for this static entry point -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #fca5a5;
            /* Light red to indicate transient state/loading */
            color: #333;
        }

        .container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            max-width: 400px;
        }

        .error {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background: #fef2f2;
            border-radius: 4px;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0ea5e9;
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="spinner" class="spinner"></div>
        <h2>Launching CHARI...</h2>
        <p id="status">Connecting to secure health record system...</p>
        <div id="error" class="error"></div>
    </div>
    <script>
        // Check for 'iss' or 'launch' parameters
        const params = new URLSearchParams(window.location.search);
        const iss = params.get('iss');

        // Example Public Sandbox (Smart Health IT R4) for standalone testing
        const DEFAULT_SANDBOX = "https://launch.smarthealthit.org/v/r4/fhir";

        // Configuration
        const config = {
            clientId: "chari-app",
            scope: "launch patient/*.read openid fhirUser",
            redirectUri: "./index.html"
        };

        // If no ISS provided, we can either error out or default to a public sandbox for testing
        if (!iss && !params.get('launch')) {
            console.warn("No ISS provided. Defaulting to Public Sandbox for testing.");
            document.getElementById('status').innerText = "Redirecting to Public Sandbox (Test Mode)...";
            config.iss = DEFAULT_SANDBOX;
        }

        FHIR.oauth2.authorize(config)
            .catch(err => {
                document.getElementById('spinner').style.display = 'none';
                document.getElementById('status').innerText = "Launch Failed";
                const errDiv = document.getElementById('error');
                errDiv.style.display = 'block';
                errDiv.innerText = err.stack || err;
            });
    </script>
</body>

</html>